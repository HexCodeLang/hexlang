<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HexLang Demo</title>
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <style>
    body {
      background-color: #0d0d0d;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      padding: 2rem;
    }
    textarea {
      width: 100%;
      height: 200px;
      background: #1a1a1a;
      color: #00ff88;
      border: none;
      padding: 1em;
      font-family: monospace;
    }
    pre {
      background: #111;
      padding: 1em;
      margin-top: 1em;
      color: #ffcc99;
    }
  </style>
</head>
<body>
  <h1>ðŸ”® HexLang Demo</h1>
  <textarea id="spell" placeholder="Write your spell here..."></textarea>
  <button py-click="cast()">ðŸª„ Cast</button>
  <pre id="output"></pre>

  <py-script>
from pyodide.ffi import create_proxy
import js

variables = {}
rituals = {}

def eval_expr(expr, scope):
    expr = expr.strip()
    if expr.startswith('"') and expr.endswith('"'):
        return expr[1:-1]
    elif expr.isdigit():
        return int(expr)
    elif expr in scope:
        return scope[expr]
    elif expr in variables:
        return variables[expr]
    elif "+" in expr:
        parts = expr.split("+")
        return "".join(str(eval_expr(p.strip(), scope)) for p in parts)
    elif "-" in expr:
        parts = expr.split("-")
        return eval_expr(parts[0], scope) - eval_expr(parts[1], scope)
    else:
        return expr  # fallback

def execute(lines, scope=None):
    if scope is None:
        scope = {}

    i = 0
    output = ""
    while i < len(lines):
        line = lines[i].strip()
        if not line or line.startswith("#"):
            i += 1
            continue
        tokens = line.split()

        if tokens[0] == "ritual":
            name = tokens[1]
            args = tokens[tokens.index("with")+1:] if "with" in tokens else []
            body = []
            i += 1
            while i < len(lines) and lines[i].strip() != "end":
                body.append(lines[i])
                i += 1
            rituals[name] = {"args": args, "body": body}
            i += 1
            continue

        if tokens[0] in rituals and "with" in tokens:
            name = tokens[0]
            call_args = tokens[tokens.index("with")+1:]
            ritual = rituals[name]
            local_scope = dict(zip(ritual["args"], [eval_expr(arg, scope) for arg in call_args]))
            result = execute(ritual["body"], local_scope)
            output += result
            i += 1
            continue

        if tokens[0] == "conjure":
            var_name = tokens[1]
            value = eval_expr(" ".join(tokens[3:]), scope)
            scope[var_name] = value
            i += 1
            continue

        if tokens[0] == "bind":
            var_name = tokens[1]
            value = eval_expr(" ".join(tokens[3:]), scope)
            scope[var_name] = value
            i += 1
            continue

        if tokens[0] == "whisper":
            msg = eval_expr(line.split(" ", 1)[1], scope)
            output += str(msg) + "\n"
            i += 1
            continue

        i += 1
    return output

def cast():
    raw = js.document.getElementById("spell").value
    console.log(f"Cast triggered with spell: {raw}")  # Logging for debugging
    lines = raw.splitlines()
    output = execute(lines)
    console.log(f"Output: {output}")  # Logging output
    js.document.getElementById("output").textContent = output
  </py-script>
</body>
</html>
